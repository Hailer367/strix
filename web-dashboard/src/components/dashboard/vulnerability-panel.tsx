'use client';

import { useState, useMemo } from 'react';
import { useStrixStore, Vulnerability } from '@/lib/store';
import { cn } from '@/lib/utils';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from '@/components/ui/tabs';
import {
  Bug,
  Search,
  AlertTriangle,
  AlertCircle,
  Info,
  Shield,
  ExternalLink,
  Copy,
  ChevronRight,
} from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

const SEVERITY_CONFIG = {
  critical: {
    color: 'bg-red-600 hover:bg-red-700',
    textColor: 'text-red-600',
    borderColor: 'border-red-600',
    bgLight: 'bg-red-600/10',
    icon: AlertTriangle,
    score: '9.0 - 10.0',
  },
  high: {
    color: 'bg-orange-500 hover:bg-orange-600',
    textColor: 'text-orange-500',
    borderColor: 'border-orange-500',
    bgLight: 'bg-orange-500/10',
    icon: AlertCircle,
    score: '7.0 - 8.9',
  },
  medium: {
    color: 'bg-yellow-500 hover:bg-yellow-600',
    textColor: 'text-yellow-500',
    borderColor: 'border-yellow-500',
    bgLight: 'bg-yellow-500/10',
    icon: AlertCircle,
    score: '4.0 - 6.9',
  },
  low: {
    color: 'bg-blue-500 hover:bg-blue-600',
    textColor: 'text-blue-500',
    borderColor: 'border-blue-500',
    bgLight: 'bg-blue-500/10',
    icon: Info,
    score: '0.1 - 3.9',
  },
  informational: {
    color: 'bg-gray-500 hover:bg-gray-600',
    textColor: 'text-gray-500',
    borderColor: 'border-gray-500',
    bgLight: 'bg-gray-500/10',
    icon: Info,
    score: '0.0',
  },
};

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
  onClick: () => void;
}

function VulnerabilityCard({ vulnerability, onClick }: VulnerabilityCardProps) {
  const config = SEVERITY_CONFIG[vulnerability.severity];
  const Icon = config.icon;

  return (
    <Card
      className={cn(
        'cursor-pointer transition-all hover:shadow-md',
        config.bgLight,
        `border-l-4 ${config.borderColor}`
      )}
      onClick={onClick}
    >
      <CardHeader className="py-3 px-4">
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-start gap-3">
            <Icon className={cn('h-5 w-5 mt-0.5', config.textColor)} />
            <div>
              <CardTitle className="text-sm font-medium leading-tight">
                {vulnerability.title}
              </CardTitle>
              <CardDescription className="text-xs mt-1">
                {vulnerability.target}
              </CardDescription>
            </div>
          </div>
          <div className="flex flex-col items-end gap-1">
            <Badge className={cn('uppercase text-xs', config.color)}>
              {vulnerability.severity}
            </Badge>
            {vulnerability.cvss && (
              <span className="text-xs text-muted-foreground">
                CVSS: {vulnerability.cvss.toFixed(1)}
              </span>
            )}
          </div>
        </div>
      </CardHeader>
      <CardContent className="py-2 px-4 pt-0">
        <p className="text-xs text-muted-foreground line-clamp-2">
          {vulnerability.description}
        </p>
        <div className="flex items-center justify-between mt-2">
          <span className="text-xs text-muted-foreground">
            {formatDistanceToNow(new Date(vulnerability.timestamp), { addSuffix: true })}
          </span>
          <ChevronRight className="h-4 w-4 text-muted-foreground" />
        </div>
      </CardContent>
    </Card>
  );
}

interface VulnerabilityDetailProps {
  vulnerability: Vulnerability;
  onClose: () => void;
}

function VulnerabilityDetail({ vulnerability, onClose }: VulnerabilityDetailProps) {
  const config = SEVERITY_CONFIG[vulnerability.severity];
  const Icon = config.icon;

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
  };

  return (
    <Dialog open={true} onOpenChange={() => onClose()}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <div className="flex items-start gap-3">
            <Icon className={cn('h-6 w-6 mt-1', config.textColor)} />
            <div>
              <DialogTitle className="text-lg">{vulnerability.title}</DialogTitle>
              <DialogDescription className="flex items-center gap-2 mt-1">
                <Badge className={cn('uppercase', config.color)}>
                  {vulnerability.severity}
                </Badge>
                {vulnerability.cwe && (
                  <Badge variant="outline">{vulnerability.cwe}</Badge>
                )}
                {vulnerability.cvss && (
                  <Badge variant="outline">CVSS: {vulnerability.cvss.toFixed(1)}</Badge>
                )}
              </DialogDescription>
            </div>
          </div>
        </DialogHeader>

        <ScrollArea className="flex-1 pr-4">
          <Tabs defaultValue="overview" className="w-full">
            <TabsList className="grid w-full grid-cols-4">
              <TabsTrigger value="overview">Overview</TabsTrigger>
              <TabsTrigger value="poc">PoC</TabsTrigger>
              <TabsTrigger value="impact">Impact</TabsTrigger>
              <TabsTrigger value="remediation">Remediation</TabsTrigger>
            </TabsList>

            <TabsContent value="overview" className="space-y-4 mt-4">
              <div>
                <h4 className="font-medium text-sm mb-2">Description</h4>
                <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                  {vulnerability.description}
                </p>
              </div>
              <div>
                <h4 className="font-medium text-sm mb-2">Target</h4>
                <code className="text-sm bg-muted px-2 py-1 rounded">
                  {vulnerability.target}
                </code>
              </div>
              <div>
                <h4 className="font-medium text-sm mb-2">Discovered</h4>
                <p className="text-sm text-muted-foreground">
                  {new Date(vulnerability.timestamp).toLocaleString()}
                </p>
              </div>
            </TabsContent>

            <TabsContent value="poc" className="space-y-4 mt-4">
              <div className="flex items-center justify-between">
                <h4 className="font-medium text-sm">Proof of Concept</h4>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => copyToClipboard(vulnerability.poc)}
                >
                  <Copy className="h-3 w-3 mr-1" />
                  Copy
                </Button>
              </div>
              <pre className="bg-muted p-4 rounded-lg text-xs overflow-x-auto whitespace-pre-wrap">
                {vulnerability.poc || 'No PoC available'}
              </pre>
            </TabsContent>

            <TabsContent value="impact" className="space-y-4 mt-4">
              <div>
                <h4 className="font-medium text-sm mb-2">Business Impact</h4>
                <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                  {vulnerability.impact || 'No impact assessment available'}
                </p>
              </div>
              <div className="flex gap-4">
                <div className="flex-1 bg-muted rounded-lg p-4">
                  <p className="text-xs text-muted-foreground">Severity</p>
                  <p className={cn('text-lg font-bold capitalize', config.textColor)}>
                    {vulnerability.severity}
                  </p>
                </div>
                {vulnerability.cvss && (
                  <div className="flex-1 bg-muted rounded-lg p-4">
                    <p className="text-xs text-muted-foreground">CVSS Score</p>
                    <p className={cn('text-lg font-bold', config.textColor)}>
                      {vulnerability.cvss.toFixed(1)}
                    </p>
                  </div>
                )}
              </div>
            </TabsContent>

            <TabsContent value="remediation" className="space-y-4 mt-4">
              <div>
                <h4 className="font-medium text-sm mb-2">Remediation Steps</h4>
                <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                  {vulnerability.remediation || 'No remediation steps available'}
                </p>
              </div>
              {vulnerability.cwe && (
                <div>
                  <h4 className="font-medium text-sm mb-2">References</h4>
                  <a
                    href={`https://cwe.mitre.org/data/definitions/${vulnerability.cwe.replace('CWE-', '')}.html`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-sm text-primary flex items-center gap-1 hover:underline"
                  >
                    {vulnerability.cwe} <ExternalLink className="h-3 w-3" />
                  </a>
                </div>
              )}
            </TabsContent>
          </Tabs>
        </ScrollArea>
      </DialogContent>
    </Dialog>
  );
}

export function VulnerabilityPanel() {
  const { vulnerabilities } = useStrixStore();
  const [searchQuery, setSearchQuery] = useState('');
  const [severityFilter, setSeverityFilter] = useState<string>('all');
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);

  const filteredVulnerabilities = useMemo(() => {
    return vulnerabilities.filter((v) => {
      const matchesSearch =
        searchQuery === '' ||
        v.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        v.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
        v.target.toLowerCase().includes(searchQuery.toLowerCase());

      const matchesSeverity =
        severityFilter === 'all' || v.severity === severityFilter;

      return matchesSearch && matchesSeverity;
    });
  }, [vulnerabilities, searchQuery, severityFilter]);

  const severityCounts = useMemo(() => {
    return {
      critical: vulnerabilities.filter((v) => v.severity === 'critical').length,
      high: vulnerabilities.filter((v) => v.severity === 'high').length,
      medium: vulnerabilities.filter((v) => v.severity === 'medium').length,
      low: vulnerabilities.filter((v) => v.severity === 'low').length,
      informational: vulnerabilities.filter((v) => v.severity === 'informational').length,
    };
  }, [vulnerabilities]);

  return (
    <div className="flex flex-col h-full">
      {/* Header */}
      <div className="px-4 py-3 border-b">
        <div className="flex items-center gap-2 mb-3">
          <Bug className="h-5 w-5 text-red-500" />
          <h2 className="font-semibold">Vulnerabilities</h2>
          <Badge variant="secondary">{vulnerabilities.length}</Badge>
        </div>

        {/* Summary badges */}
        <div className="flex flex-wrap gap-2 mb-3">
          {severityCounts.critical > 0 && (
            <Badge className="bg-red-600">
              {severityCounts.critical} Critical
            </Badge>
          )}
          {severityCounts.high > 0 && (
            <Badge className="bg-orange-500">
              {severityCounts.high} High
            </Badge>
          )}
          {severityCounts.medium > 0 && (
            <Badge className="bg-yellow-500 text-black">
              {severityCounts.medium} Medium
            </Badge>
          )}
          {severityCounts.low > 0 && (
            <Badge className="bg-blue-500">
              {severityCounts.low} Low
            </Badge>
          )}
        </div>

        {/* Filters */}
        <div className="flex gap-2">
          <div className="relative flex-1">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search vulnerabilities..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-8"
            />
          </div>
          <Select value={severityFilter} onValueChange={setSeverityFilter}>
            <SelectTrigger className="w-[140px]">
              <SelectValue placeholder="Severity" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All</SelectItem>
              <SelectItem value="critical">Critical</SelectItem>
              <SelectItem value="high">High</SelectItem>
              <SelectItem value="medium">Medium</SelectItem>
              <SelectItem value="low">Low</SelectItem>
              <SelectItem value="informational">Info</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* Vulnerability list */}
      <ScrollArea className="flex-1">
        <div className="p-4 space-y-3">
          {filteredVulnerabilities.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 text-muted-foreground">
              <Shield className="h-12 w-12 mb-4 opacity-50" />
              <p className="text-sm">
                {vulnerabilities.length === 0
                  ? 'No vulnerabilities found yet'
                  : 'No matching vulnerabilities'}
              </p>
            </div>
          ) : (
            filteredVulnerabilities.map((vuln) => (
              <VulnerabilityCard
                key={vuln.id}
                vulnerability={vuln}
                onClick={() => setSelectedVuln(vuln)}
              />
            ))
          )}
        </div>
      </ScrollArea>

      {/* Detail modal */}
      {selectedVuln && (
        <VulnerabilityDetail
          vulnerability={selectedVuln}
          onClose={() => setSelectedVuln(null)}
        />
      )}
    </div>
  );
}

name: Qwen Code Multi-Account Token Collection

on:
  workflow_dispatch:
    inputs:
      num_accounts:
        description: 'Number of Qwen Code accounts to authenticate'
        required: true
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'
          - '10'
      encryption_password:
        description: 'Password for encrypting tokens (remember this!)'
        required: true
        type: string

jobs:
  collect-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install CLIProxyAPI
        run: |
          git clone https://github.com/router-for-me/CLIProxyAPI.git
          cd CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo mv cli-proxy-api /usr/local/bin/
          cd ..
          rm -rf CLIProxyAPI

      - name: Create auth directory
        run: |
          # Create the main auth directory
          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"
          
          # Create separate directories for each account
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            ACCOUNT_DIR="$AUTH_DIR/account-$i"
            mkdir -p "$ACCOUNT_DIR"
            chmod 700 "$ACCOUNT_DIR"
            echo "Created directory for account $i: $ACCOUNT_DIR"
          done
          
          # Verify main directory exists
          if [ ! -d "$AUTH_DIR" ]; then
            echo "Failed to create auth directory"
            exit 1
          fi
          
          # Create the auth-urls directory
          mkdir -p ./auth-urls
          
          echo ""
          echo "Auth directory structure:"
          ls -la "$AUTH_DIR"
          echo ""
          ls -la "$AUTH_DIR"/*/ 2>/dev/null || true

      - name: Create minimal config file
        run: |
          # Create a separate config file for each account with its own auth-dir
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            cat > config-account-$i.yaml << EOF
          port: $((8080 + i - 1))
          auth-dir: "$HOME/.cli-proxy-api/account-$i"
          debug: false
          EOF
            
            echo "Config file created for account $i:"
            cat config-account-$i.yaml
            echo ""
          done

      - name: Authenticate accounts sequentially
        run: |
          echo "=========================================="
          echo "QWEN CODE AUTHENTICATION - SEQUENTIAL MODE"
          echo "=========================================="
          echo ""
          echo "Authenticating ${{ github.event.inputs.num_accounts }} account(s) one at a time..."
          echo "Each account must complete authentication before the next begins."
          echo ""
          
          # Function to wait for token file
          wait_for_token() {
            local account_num=$1
            local account_dir="$HOME/.cli-proxy-api/account-$account_num"
            local max_wait=600  # 10 minutes
            local elapsed=0
            local check_interval=2
            
            echo "â³ Waiting for account $account_num authentication to complete..."
            echo "   Checking directory: $account_dir"
            echo ""
            
            while [ $elapsed -lt $max_wait ]; do
              # Check if token file exists
              if ls "$account_dir"/qwen-*.json >/dev/null 2>&1; then
                echo "âœ… Account $account_num authenticated successfully!"
                echo "   Token file found: $(ls "$account_dir"/qwen-*.json)"
                return 0
              fi
              
              # Show progress every 10 seconds
              if [ $((elapsed % 10)) -eq 0 ] && [ $elapsed -gt 0 ]; then
                echo "   Still waiting... (${elapsed}s elapsed)"
              fi
              
              sleep $check_interval
              elapsed=$((elapsed + check_interval))
            done
            
            echo "âŒ Timeout waiting for account $account_num authentication"
            return 1
          }
          
          # Authenticate each account sequentially
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“± ACCOUNT $i - AUTHENTICATION"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # Use account-specific config file
            CONFIG_PATH="$(pwd)/config-account-$i.yaml"
            
            if [ ! -f "$CONFIG_PATH" ]; then
              echo "Error: Config file not found at $CONFIG_PATH"
              exit 1
            fi
            
            echo "Starting authentication server for account $i..."
            echo ""
            
            # Start the CLI proxy API server in the background with logging
            cli-proxy-api -config "$CONFIG_PATH" -qwen-login > "server-$i.log" 2>&1 &
            SERVER_PID=$!
            
            echo "Server started with PID: $SERVER_PID"
            
            # Wait a moment for server to start and generate URL
            sleep 5
            
            # Extract and display the OAuth URL
            if [ -f "server-$i.log" ]; then
              URL=$(grep -oP 'https://[^\s]+' "server-$i.log" | head -1 || echo "")
              
              if [ -n "$URL" ]; then
                echo "ðŸ”— CLICK THIS URL TO AUTHENTICATE ACCOUNT $i:"
                echo ""
                echo "   $URL"
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                
                # Save URL to file for summary
                echo "$URL" > ./auth-urls/account-$i-url.txt
              else
                echo "âš ï¸  Could not extract OAuth URL from logs"
                echo "Server log contents:"
                cat "server-$i.log"
              fi
            fi
            
            # Wait for this account to authenticate before proceeding
            if wait_for_token $i; then
              echo ""
              echo "ðŸŽ‰ Account $i is ready! Moving to next account..."
              echo ""
              
              # Kill the server for this account
              kill $SERVER_PID 2>/dev/null || true
              sleep 2
            else
              echo ""
              echo "âŒ Failed to authenticate account $i within timeout period"
              echo "âš ï¸  Stopping workflow. Please try again."
              
              # Kill the server
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ ALL ACCOUNTS AUTHENTICATED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: Display all authentication URLs in summary
        run: |
          echo "## ðŸ” Qwen Code Authentication URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Authentication was completed sequentially. Below are the URLs that were used:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "### Account $i" >> $GITHUB_STEP_SUMMARY
            if [ -f ./auth-urls/account-$i-url.txt ]; then
              URL=$(cat ./auth-urls/account-$i-url.txt)
              echo "- âœ… Authenticated successfully" >> $GITHUB_STEP_SUMMARY
              echo "- URL used: \`${URL:0:50}...\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸  Authentication data not found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Verify collected tokens
        run: |
          echo "Verifying collected tokens..."
          echo ""
          
          # Check each account directory
          TOKEN_COUNT=0
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            ACCOUNT_DIR="$HOME/.cli-proxy-api/account-$i"
            if ls "$ACCOUNT_DIR"/qwen-*.json 1>/dev/null 2>&1; then
              TOKEN_COUNT=$((TOKEN_COUNT + 1))
              echo "âœ… Account $i: Token found"
              ls -lh "$ACCOUNT_DIR"/qwen-*.json
            else
              echo "âŒ Account $i: No token found in $ACCOUNT_DIR"
              echo "   Directory contents:"
              ls -la "$ACCOUNT_DIR" || echo "   Directory does not exist or is empty"
            fi
          done
          
          echo ""
          echo "Total tokens collected: $TOKEN_COUNT/${{ github.event.inputs.num_accounts }}"
          echo ""
          
          if [ "$TOKEN_COUNT" -eq "0" ]; then
            echo "âŒ No tokens found!"
            echo "OAuth authentication was not completed."
            echo ""
            echo "Debug information:"
            echo "Main auth directory contents:"
            ls -la "$HOME/.cli-proxy-api"
            echo ""
            exit 1
          fi
          
          if [ "$TOKEN_COUNT" -lt "${{ github.event.inputs.num_accounts }}" ]; then
            echo "âš ï¸  Warning: Expected ${{ github.event.inputs.num_accounts }} tokens but found $TOKEN_COUNT"
            echo "This should not happen with sequential authentication."
            echo "Proceeding anyway with collected tokens."
            echo ""
          else
            echo "ðŸŽ‰ All expected tokens collected successfully!"
            echo ""
          fi

      - name: Collect and encrypt tokens
        run: |
          echo "Collecting tokens from all account directories..."
          echo ""
          
          # Create a temporary directory to collect all tokens
          TEMP_DIR=$(mktemp -d)
          
          # Copy all token files to temp directory with unique names
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            ACCOUNT_DIR="$HOME/.cli-proxy-api/account-$i"
            if ls "$ACCOUNT_DIR"/qwen-*.json 1>/dev/null 2>&1; then
              # Rename token to include account number to avoid conflicts
              cp "$ACCOUNT_DIR"/qwen-*.json "$TEMP_DIR/qwen-account-$i.json"
              echo "âœ… Collected token from account $i"
            fi
          done
          
          # Verify we have tokens
          TOKEN_COUNT=$(ls "$TEMP_DIR"/qwen-*.json 2>/dev/null | wc -l)
          if [ "$TOKEN_COUNT" -eq "0" ]; then
            echo "âŒ No tokens to encrypt!"
            exit 1
          fi
          
          echo ""
          echo "Tokens to be encrypted:"
          ls -lh "$TEMP_DIR"/qwen-*.json
          echo ""
          
          # Create tarball of all collected tokens
          cd "$TEMP_DIR"
          tar -czf qwen-tokens.tar.gz qwen-*.json
          echo "âœ… Tokens collected in tarball"
          
          # Use user-provided password for encryption
          USER_PASSWORD="${{ github.event.inputs.encryption_password }}"
          
          # Encrypt the tokens
          echo "$USER_PASSWORD" | openssl enc -aes-256-cbc -salt -pbkdf2 -in qwen-tokens.tar.gz -out qwen-tokens.enc -pass stdin
          echo "âœ… Tokens encrypted with your password"
          
          # Base64 encode for GitHub Secrets
          base64 -w 0 qwen-tokens.enc > qwen-tokens.b64
          echo "âœ… Tokens base64 encoded"
          
          # Move the final file to home directory for later access
          mv qwen-tokens.b64 "$HOME/"
          
          # Display results
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ENCRYPTED TOKENS READY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Number of accounts: $TOKEN_COUNT"
          echo "Encrypted token size: $(stat -c%s "$HOME/qwen-tokens.b64") bytes"
          echo ""
          
          # Cleanup temp directory
          rm -rf "$TEMP_DIR"

      - name: Prepare GitHub Secrets instructions
        run: |
          # Read the encrypted token from home directory
          ENCRYPTED_TOKEN=$(cat "$HOME/qwen-tokens.b64")
          
          echo "## ðŸŽ‰ Tokens Successfully Collected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your Qwen Code tokens have been encrypted and are ready to upload to GitHub Secrets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to your repository **Settings** â†’ **Secrets and variables** â†’ **Actions**" >> $GITHUB_STEP_SUMMARY
          echo "2. Click **New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "3. Create the following secret:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Secret Name: \`QWEN_TOKENS\`" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$ENCRYPTED_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** Remember your encryption password - you'll need it to decrypt!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… After creating this secret, use the **CLIProxyAPI Server** workflow to start your API endpoint!" >> $GITHUB_STEP_SUMMARY

      - name: Upload token files as artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: qwen-encrypted-tokens
          path: ~/qwen-tokens.b64
          retention-days: 1
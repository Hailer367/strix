name: Qwen Code Multi-Account Token Collection

on:
  workflow_dispatch:
    inputs:
      num_accounts:
        description: 'Number of Qwen Code accounts to authenticate'
        required: true
        default: '3'
        type: choice
        options: ['1','2','3','4','5','6','7','8','9','10']
      encryption_password:
        description: 'Password for encrypting tokens (remember this!)'
        required: true
        type: string

jobs:
  collect-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # ---------- 1.  install CLIProxyAPI ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install CLIProxyAPI
        run: |
          git clone https://github.com/luispater/CLIProxyAPI.git
          cd CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server   # â† build it
          sudo cp cli-proxy-api /usr/local/bin/cliproxyapi
          cd ..
          rm -rf CLIProxyAPI
          cliproxyapi --help

      # ---------- 2.  create per-account folders ----------
      - name: Create auth directory structure
        run: |
          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            mkdir -p "$AUTH_DIR/account-$i"
            chmod 700 "$AUTH_DIR/account-$i"
          done

      # ---------- 3.  create per-account config ----------
      - name: Create config files for each account
        run: |
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            cat > config-account-$i.yaml <<EOF
          port: 8317
          auth-dir: "$HOME/.cli-proxy-api/account-$i"
          debug: true
          logging-to-file: true
          EOF
          done

      # ---------- 4.  authenticate sequentially ----------
      - name: Authenticate accounts sequentially
        env:
          QWEN_ALIASES: ${{ secrets.QWEN_ALIASES }}   # <-- "acc1,acc2,acc3,..."
        run: |
          # --- 1.  split secret into array ---
          IFS=',' read -r -a ALIAS_ARRAY <<< "$QWEN_ALIASES"
          NEEDED=${{ github.event.inputs.num_accounts }}
          if [ "${#ALIAS_ARRAY[@]}" -lt "$NEEDED" ]; then
            echo "âŒ  Secret QWEN_ALIASES contains ${#ALIAS_ARRAY[@]} aliases, but $NEEDED accounts requested"
            exit 1
          fi

          # --- 2.  build patched CLIProxyAPI (reads QWEN_ALIAS env-var) ---
          git clone https://github.com/YOUR_FORK/CLIProxyAPI.git   # â† your fork that uses os.Getenv("QWEN_ALIAS")
          cd CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo cp cli-proxy-api /usr/local/bin/cliproxyapi
          cd .. && rm -rf CLIProxyAPI

          # --- 3.  authenticate each account ---
          for i in $(seq 1 "$NEEDED"); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“± ACCOUNT $i / $NEEDED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            CONFIG="config-account-$i.yaml"
            ACCOUNT_DIR="$HOME/.cli-proxy-api/account-$i"

            # pick alias for this account (zero-based array)
            export QWEN_ALIAS="${ALIAS_ARRAY[$((i-1))]}"

            # start server (background)
            nohup cliproxyapi -config "$CONFIG" -qwen-login > server-$i.log 2>&1 &
            SERVER_PID=$!

            # wait for OAuth URL
            for retry in {1..30}; do
              URL=$(grep -oP 'https://[^\s]+' server-$i.log | head -1)
              [ -n "$URL" ] && break
              sleep 2
            done
            [ -z "$URL" ] && { echo "âŒ No OAuth URL"; exit 1; }

            echo "ðŸ‘‰ Browser URL (auto-finishing with alias $QWEN_ALIAS):"
            echo "   $URL"

            # wait for token file
            for s in {1..600}; do
              TOKEN=$(find "$ACCOUNT_DIR" -maxdepth 1 -name 'qwen-*.json' -print -quit)
              [ -n "$TOKEN" ] && echo "âœ… Token detected: $(basename "$TOKEN")" && break
              sleep 1
            done
            [ -z "$TOKEN" ] && { echo "âŒ Timeout"; exit 1; }

            kill $SERVER_PID 2>/dev/null || true
            echo "â¸ï¸  5 s pause â€¦"; sleep 5
          done

      # ---------- 5.  verify & encrypt ----------
      - name: Verify and count tokens
        run: |
          TOKEN_COUNT=$(find "$HOME/.cli-proxy-api" -name 'qwen-*.json' | wc -l)
          echo "Tokens collected: $TOKEN_COUNT"
          [ "$TOKEN_COUNT" -eq 0 ] && echo "âŒ No tokens!" && exit 1

      - name: Collect and encrypt tokens
        run: |
          TEMP=$(mktemp -d)
          find "$HOME/.cli-proxy-api" -name 'qwen-*.json' -exec cp {} "$TEMP/" \;
          cd "$TEMP"
          tar -czf qwen-tokens.tar.gz qwen-*.json
          openssl enc -aes-256-cbc -salt -pbkdf2 \
            -in qwen-tokens.tar.gz -out qwen-tokens.enc \
            -pass pass:${{ github.event.inputs.encryption_password }}
          base64 -w 0 qwen-tokens.enc > "$HOME/qwen-tokens.b64"
          rm -rf "$TEMP"

      # ---------- 6.  upload artifact ----------
      - name: Upload encrypted tokens
        uses: actions/upload-artifact@v4
        with:
          name: qwen-encrypted-tokens
          path: ~/qwen-tokens.b64
          retention-days: 1

      - name: Job summary
        run: |
          echo "## âœ…  All ${{ github.event.inputs.num_accounts }} Qwen tokens collected & encrypted" >> $GITHUB_STEP_SUMMARY
          echo "Upload the artifact **qwen-encrypted-tokens** to your secret store and remember the encryption password!" >> $GITHUB_STEP_SUMMARY

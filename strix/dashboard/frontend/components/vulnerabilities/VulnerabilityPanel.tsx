'use client'

import { useMemo } from 'react'
import { Bug } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import type { Vulnerability } from '@/types'
import { cn } from '@/lib/utils'

interface VulnerabilityPanelProps {
  vulnerabilities: Vulnerability[] | undefined
}

export function VulnerabilityPanel({ vulnerabilities }: VulnerabilityPanelProps) {
  const counts = useMemo(() => {
    const c = { critical: 0, high: 0, medium: 0, low: 0, info: 0 }
    vulnerabilities?.forEach((v) => {
      const sev = (v.severity || 'info').toLowerCase()
      if (sev in c) {
        c[sev as keyof typeof c]++
      }
    })
    return c
  }, [vulnerabilities])

  const getSeverityColor = (severity: string) => {
    const sev = severity.toLowerCase()
    switch (sev) {
      case 'critical':
        return 'text-red-500 font-semibold'
      case 'high':
        return 'text-orange-500'
      case 'medium':
        return 'text-yellow-500'
      case 'low':
        return 'text-green-500'
      default:
        return 'text-blue-500'
    }
  }

  const getSeverityBadgeVariant = (severity: string) => {
    const sev = severity.toLowerCase()
    switch (sev) {
      case 'critical':
        return 'destructive'
      case 'high':
        return 'warning'
      case 'medium':
        return 'warning'
      default:
        return 'info'
    }
  }

  return (
    <Card className="h-full">
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium flex items-center gap-2">
          <Bug className="h-4 w-4" />
          Vulnerabilities
        </CardTitle>
        <Badge variant="secondary">{vulnerabilities?.length || 0}</Badge>
      </CardHeader>
      <CardContent>
        {/* Severity Breakdown */}
        <div className="grid grid-cols-5 gap-2 mb-4 text-center">
          <div>
            <div className={cn('text-lg font-bold', getSeverityColor('critical'))}>
              {counts.critical}
            </div>
            <div className="text-xs text-muted-foreground">Critical</div>
          </div>
          <div>
            <div className={cn('text-lg font-bold', getSeverityColor('high'))}>
              {counts.high}
            </div>
            <div className="text-xs text-muted-foreground">High</div>
          </div>
          <div>
            <div className={cn('text-lg font-bold', getSeverityColor('medium'))}>
              {counts.medium}
            </div>
            <div className="text-xs text-muted-foreground">Medium</div>
          </div>
          <div>
            <div className={cn('text-lg font-bold', getSeverityColor('low'))}>
              {counts.low}
            </div>
            <div className="text-xs text-muted-foreground">Low</div>
          </div>
          <div>
            <div className={cn('text-lg font-bold', getSeverityColor('info'))}>
              {counts.info}
            </div>
            <div className="text-xs text-muted-foreground">Info</div>
          </div>
        </div>

        {/* Vulnerability List */}
        <div className="space-y-2 max-h-48 overflow-y-auto">
          {!vulnerabilities || vulnerabilities.length === 0 ? (
            <div className="text-center text-muted-foreground py-4 text-sm">
              No vulnerabilities discovered yet
            </div>
          ) : (
            vulnerabilities.slice(0, 20).map((vuln, idx) => (
              <div
                key={idx}
                className="p-2 rounded bg-muted/50 hover:bg-muted transition-colors"
              >
                <div className="flex items-center justify-between">
                  <span className={cn('text-sm font-medium', getSeverityColor(vuln.severity))}>
                    {vuln.title || 'Vulnerability'}
                  </span>
                  <Badge variant={getSeverityBadgeVariant(vuln.severity)}>
                    {vuln.severity || 'info'}
                  </Badge>
                </div>
                {vuln.target && (
                  <div className="text-xs text-muted-foreground mt-1 truncate">
                    {vuln.target}
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </CardContent>
    </Card>
  )
}